# YNDU Deployment Guide

This directory contains scripts and configuration for deploying YNDU to a VPS.

## Quick Start

### 1. Prepare Your VPS

SSH into your VPS and run the setup script:

```bash
# Download the setup script
curl -O https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/deploy/vps-setup.sh
chmod +x vps-setup.sh

# Run the setup (replace with your domain)
sudo ./vps-setup.sh \
  --domain yourdomain.com \
  --repo https://github.com/rorimwema/yndu.git \
  --tag latest \
  --cert /root/cert.pem \
  --key /root/key.pem
```

### 2. Configure GitHub Secrets

Follow the instructions in [github-secrets-setup.md](github-secrets-setup.md) to set up required
secrets.

### 3. Deploy

Push to the `main` branch, and GitHub Actions will automatically deploy your application.

---

## Deployment Methods

### Method 1: GitHub Actions (Recommended)

Automatically deploys when you push to `main` branch.

1. Set up secrets in GitHub repository settings
2. Push code to `main`
3. GitHub Actions builds and deploys automatically

### Method 2: Manual Deployment

Use the manual deploy script on your VPS:

```bash
# On your VPS, in the deployment directory
cd /opt/yndu

# Deploy latest images
./manual-deploy.sh

# Or deploy specific tag
./manual-deploy.sh --tag v1.2.3
```

### Method 3: Docker Swarm (Production)

```bash
cd /opt/yndu

# Create/update secrets from secrets/prod
./scripts/swarm/create-secrets.sh

# Deploy stack
export REGISTRY=ghcr.io/rorimwema
export IMAGE_NAME=yndu
export TAG=latest
export CORS_ORIGIN=https://yourdomain.com
docker stack deploy -c docker-stack.yml yndu

# View logs
docker service logs -f yndu_nginx
```

---

## Directory Structure

```
/opt/yndu/
├── docker-compose.production.yml    # Production compose file
├── docker-compose.prod.override.yml # Auto-generated by CI/CD
├── docker-compose.manual.yml        # For manual deployments
├── .env.production                  # Production environment variables
├── nginx/
│   ├── production.conf              # HTTP nginx config
│   ├── production-ssl.conf          # HTTPS nginx config
│   └── ssl/                         # SSL certificates
│       ├── cert.pem
│       └── key.pem
├── postgres_data/                   # PostgreSQL data volume
├── redis_data/                      # Redis data volume
├── deploy.sh                        # Deployment script
├── monitor.sh                       # Monitoring script
├── backup.sh                        # Backup script
└── manual-deploy.sh                 # Manual deployment script
```

---

## SSL/TLS Certificates

SSL certificates are automatically managed by Let's Encrypt:

- **Auto-renewal:** Configured via cron job (runs daily at noon)
- **Manual renewal:** `sudo certbot renew`
- **Certificate location:** `/etc/letsencrypt/live/yourdomain.com/`

---

## Monitoring & Maintenance

### View Service Status

```bash
/opt/yndu/monitor.sh
```

### View Logs

```bash
# All services
docker compose -f docker-compose.production.yml logs -f

# Specific service
docker compose -f docker-compose.production.yml logs -f backend
```

### Backup Database

```bash
# Manual backup
/opt/yndu/backup.sh

# Backups are stored in /var/backups/yndu/
# Automated backups run daily at 2 AM
```

### Update Services

```bash
# Pull latest images and restart
docker compose -f docker-compose.production.yml pull
docker compose -f docker-compose.production.yml up -d
```

### Restart Services

```bash
# Restart all
docker compose -f docker-compose.production.yml restart

# Restart specific service
docker compose -f docker-compose.production.yml restart backend
```

---

## Troubleshooting

### Services Not Starting

```bash
# Check logs
docker compose -f docker-compose.production.yml logs

# Check container status
docker ps -a

# Check resource usage
docker stats --no-stream
```

### Database Connection Issues

```bash
# Check if database is running
docker compose -f docker-compose.production.yml ps postgres

# Access database shell
docker compose -f docker-compose.production.yml exec postgres psql -U postgres -d yndu_prod
```

### SSL Certificate Issues

```bash
# Check certificate status
sudo certbot certificates

# Renew manually
sudo certbot renew --force-renewal

# Copy renewed certificates
sudo cp /etc/letsencrypt/live/yourdomain.com/fullchain.pem /opt/yndu/nginx/ssl/cert.pem
sudo cp /etc/letsencrypt/live/yourdomain.com/privkey.pem /opt/yndu/nginx/ssl/key.pem
docker compose -f docker-compose.production.yml restart nginx
```

### Out of Memory

```bash
# Check memory usage
free -h

# Check docker memory usage
docker system df -v

# Clean up unused resources
docker system prune -af
docker volume prune -f
```

---

## Security Checklist

- [ ] Change default database passwords in `.env.production`
- [ ] Change JWT_SECRET in `.env.production`
- [ ] Change NUXT_SESSION_PASSWORD in `.env.production`
- [ ] Set up firewall (UFW) - done by setup script
- [ ] Enable automatic security updates: `sudo apt install unattended-upgrades`
- [ ] Regularly update Docker images
- [ ] Monitor logs for suspicious activity
- [ ] Rotate SSH keys periodically

---

## Environment Variables

Required environment variables in `.env.production`:

| Variable                | Description                 | Required |
| ----------------------- | --------------------------- | -------- |
| `DATABASE_PASSWORD`     | PostgreSQL password         | Yes      |
| `REDIS_PASSWORD`        | Redis password              | Yes      |
| `JWT_SECRET`            | JWT signing secret          | Yes      |
| `NUXT_SESSION_PASSWORD` | Session encryption key      | Yes      |
| `HASHPAY_API_KEY`       | Payment provider API key    | No       |
| `HASHPAY_ACCOUNT_ID`    | Payment provider account ID | No       |

---

## Support

For issues or questions:

1. Check the troubleshooting section above
2. Review GitHub Actions logs
3. Check VPS logs: `journalctl -u yndu.service`
