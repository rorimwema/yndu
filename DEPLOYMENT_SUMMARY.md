# CI/CD Pipeline - Deployment Summary

## ğŸš€ What's Been Created

### GitHub Actions Workflows (`.github/workflows/`)

| File | Purpose | Trigger |
|------|---------|---------|
| `ci.yml` | Lint, test, build, push images | Push to any branch, PR |
| `deploy.yml` | Deploy to VPS | Push to main, Manual |
| `rollback.yml` | Rollback to previous version | Manual |

### Deployment Scripts (`deploy/`)

| File | Purpose | Location |
|------|---------|----------|
| `vps-setup.sh` | One-time VPS setup | Run on VPS |
| `manual-deploy.sh` | Manual deployment | Run on VPS |
| `github-secrets-setup.md` | Secrets documentation | Reference |
| `README.md` | Deployment guide | Reference |
| `docker-compose.staging.yml` | Staging environment | Override |

### Configuration Files

| File | Purpose |
|------|---------|
| `.env.production.example` | Production env template |
| `nginx/production-ssl.conf` | HTTPS nginx config |
| `docker-compose.production.yml` | Production services |

---

## ğŸ“‹ Setup Checklist

### Step 1: VPS Setup (One-time)
```bash
# SSH into your VPS
ssh root@your-vps-ip

# Download and run setup
curl -O https://raw.githubusercontent.com/YOUR_USERNAME/YOUR_REPO/main/deploy/vps-setup.sh
chmod +x vps-setup.sh
sudo DOMAIN=yourdomain.com EMAIL=admin@yourdomain.com ./vps-setup.sh
```

### Step 2: GitHub Secrets
Go to **Settings â†’ Secrets and variables â†’ Actions**

| Secret | Value Example |
|--------|---------------|
| `VPS_SSH_KEY` | `-----BEGIN OPENSSH PRIVATE KEY-----...` |
| `VPS_HOST` | `203.0.113.1` or `vps.yourdomain.com` |
| `VPS_USER` | `root` or `ubuntu` |
| `DOMAIN` | `app.yourdomain.com` |
| `DEPLOY_PATH` | `/opt/yndu` |

### Step 3: Push & Deploy
```bash
git add .
git commit -m "Add CI/CD pipeline"
git push origin main
```

---

## ğŸ”§ Workflow Details

### CI Workflow (`ci.yml`)

```
Push/PR
    â”‚
    â”œâ”€â”€ Backend Checks
    â”‚   â”œâ”€â”€ Lint (deno lint)
    â”‚   â”œâ”€â”€ Format check (deno fmt --check)
    â”‚   â”œâ”€â”€ Type check (deno check)
    â”‚   â””â”€â”€ Unit tests
    â”‚
    â”œâ”€â”€ Frontend Checks
    â”‚   â”œâ”€â”€ Install dependencies
    â”‚   â””â”€â”€ Build
    â”‚
    â”œâ”€â”€ Microservices Checks
    â”‚   â””â”€â”€ Syntax check (users, inventory, orders, gateway)
    â”‚
    â””â”€â”€ Build & Push Images (main branch only)
        â”œâ”€â”€ backend â†’ ghcr.io/user/repo/backend:sha
        â”œâ”€â”€ frontend â†’ ghcr.io/user/repo/frontend:sha
        â”œâ”€â”€ users â†’ ghcr.io/user/repo/users:sha
        â”œâ”€â”€ inventory â†’ ghcr.io/user/repo/inventory:sha
        â”œâ”€â”€ orders â†’ ghcr.io/user/repo/orders:sha
        â””â”€â”€ gateway â†’ ghcr.io/user/repo/gateway:sha
```

### Deploy Workflow (`deploy.yml`)

```
Push to main
    â”‚
    â”œâ”€â”€ SSH to VPS
    â”œâ”€â”€ Login to GHCR
    â”œâ”€â”€ Pull images
    â”œâ”€â”€ Create compose override
    â”œâ”€â”€ Deploy with zero downtime
    â”œâ”€â”€ Health checks
    â””â”€â”€ Cleanup
```

---

## ğŸŒ Architecture

```
User
  â”‚ HTTPS
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nginx      â”‚  â† SSL termination, reverse proxy
â”‚  Port 443   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â–º Frontend (Nuxt) :3000
       â”‚
       â”œâ”€â”€â–º Backend (Deno)  :8000/api
       â”‚
       â””â”€â”€â–º Gateway (Node)  :4000/graphql
              â”‚
              â”œâ”€â”€â–º Users      :4001
              â”œâ”€â”€â–º Inventory  :4002
              â””â”€â”€â–º Orders     :4003

Internal:
  â”œâ”€â”€ Postgres :5432
  â””â”€â”€ Redis    :6379
```

---

## ğŸ“ File Structure on VPS

```
/opt/yndu/
â”œâ”€â”€ docker-compose.production.yml     # Base compose file
â”œâ”€â”€ docker-compose.prod.override.yml  # Auto-generated by CI/CD
â”œâ”€â”€ docker-compose.manual.yml         # For manual deployments
â”œâ”€â”€ .env.production                   # Environment variables (MANUAL)
â”œâ”€â”€ nginx/
â”‚   â”œâ”€â”€ production.conf               # HTTP config
â”‚   â”œâ”€â”€ production-ssl.conf           # HTTPS config
â”‚   â””â”€â”€ ssl/                          # SSL certificates
â”‚       â”œâ”€â”€ cert.pem
â”‚       â””â”€â”€ key.pem
â”œâ”€â”€ deploy.sh                         # Auto-generated by CI/CD
â”œâ”€â”€ monitor.sh                        # Status monitor
â”œâ”€â”€ backup.sh                         # Database backup
â”œâ”€â”€ manual-deploy.sh                  # Manual deployment
â”œâ”€â”€ postgres_data/                    # Database volume
â””â”€â”€ redis_data/                       # Cache volume
```

---

## ğŸ› ï¸ Common Commands

### View Status
```bash
# On VPS
/opt/yndu/monitor.sh

# Or
docker compose -f docker-compose.production.yml ps
docker stats --no-stream
```

### View Logs
```bash
# All services
docker compose -f docker-compose.production.yml logs -f

# Specific service
docker compose -f docker-compose.production.yml logs -f backend
```

### Manual Deploy
```bash
cd /opt/yndu
./manual-deploy.sh --tag v1.2.3
```

### Backup Database
```bash
/opt/yndu/backup.sh
```

### Restart Services
```bash
# All
docker compose -f docker-compose.production.yml restart

# One service
docker compose -f docker-compose.production.yml restart backend
```

---

## ğŸ” Security Checklist

- [ ] Change all passwords in `.env.production`
- [ ] Change `JWT_SECRET` (min 64 chars)
- [ ] Change `NUXT_SESSION_PASSWORD` (min 32 chars)
- [ ] Set up firewall (done by setup script)
- [ ] Enable automatic security updates
- [ ] Restrict SSH to key-only auth
- [ ] Set up fail2ban
- [ ] Monitor logs regularly

---

## ğŸš¨ Troubleshooting

### Deployment Failed
```bash
# Check GitHub Actions logs
# Actions tab â†’ Failed workflow

# Check VPS logs
ssh root@your-vps-ip "cd /opt/yndu && docker compose logs --tail=50"
```

### Health Check Failing
```bash
# Test locally on VPS
curl http://localhost:8000/health
curl http://localhost:3000

# Check logs
docker compose -f docker-compose.production.yml logs backend
```

### SSL Issues
```bash
# Renew certificate
sudo certbot renew --force-renewal

# Copy certs
cp /etc/letsencrypt/live/yourdomain.com/*.pem /opt/yndu/nginx/ssl/

# Restart nginx
docker compose -f docker-compose.production.yml restart nginx
```

---

## ğŸ“ Next Steps

1. **Test locally first:**
   ```bash
   docker compose -f docker-compose.production.yml up -d
   ```

2. **Set up VPS:** Run `vps-setup.sh` on your server

3. **Configure secrets:** Add all required GitHub secrets

4. **Push and deploy:** Commit and push to trigger CI/CD

5. **Verify:** Check that your app is live at `https://yourdomain.com`

---

## ğŸ“š Documentation

| File | Purpose |
|------|---------|
| `CICD_SETUP.md` | Complete setup guide |
| `deploy/README.md` | VPS deployment guide |
| `deploy/github-secrets-setup.md` | Secrets configuration |
| `.env.production.example` | Environment template |

---

## ğŸ¯ Features

âœ… **Automated CI/CD** - Push to deploy  
âœ… **Zero-downtime deployment** - Rolling updates  
âœ… **SSL/TLS** - Automatic Let's Encrypt  
âœ… **Health checks** - Automatic verification  
âœ… **Rollback** - One-click rollback  
âœ… **Monitoring** - Resource usage tracking  
âœ… **Backups** - Automated database backups  
âœ… **Security** - Non-root containers, secrets management  

---

**Questions?** Check the detailed guides in `CICD_SETUP.md` and `deploy/README.md`
